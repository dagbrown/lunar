#!/usr/bin/python

from lunar import moonbase, modules
from lunar.pkgdb import pkgdb
from lunar.messages import *
import argparse

def helpscreen():
  print """
LVU -- Lunar View utility (for viewing just about everything in Lunar-Linux)

Usage:      lvu [general options] [command [command parameters]]

GENERAL OPTIONS:

-d  |  --debug                  Enables debug messages
-h  |  --help                   Displays this help text
-v  |  --verbose                Increases the level of message output

Commands:

Invoke lvu with desired command followed by arguments.
Please note that anything in brackets [ ] is optional.

Command     Arguments      Description

what        module         display a module's description
short       module         display a module's short description
where       module         display a module's section
cd          module         change directory to module and execs a new shell
alien                      discover untracked files
from        path/file      discover what installed a given file
leafs                      display installed modules that have no explicit
                               dependencies on them
orphans                    display installed modules that are missing
                               dependencies
conflicts                  display conflicting files
moonalyze                  analyze the current moonbase for common issues
held                       display held modules
exiled                     display exiled modules
enforced                   display enforced modules
expired                    display a list of modules which need an update
info        module         display terse summary information about module

search      "phrase"       searches all modules long descriptions for phrase.
service     port|acronym   displays modules that provide that service

website     module         display a module's website
install     module         display an install log
size        [module]       find and show installed size of a module
                               or ALL (slow)
installed   [module]       display installed modules/version of module
missing                    display installed but deleted modules from moonbase
compile     module         display a compile log
compiler    module         display the compiler version used
links       module         display a list of modules that this module links to
sources     [module]       display source files for a module
urls        [module]       display all URLs for a module
maintainer  module         display maintainer for a module
version     module         display version of module in moonbase

new         module         attempt to create a new module from scratch
edit        module         copy a module to zlocal for editing
diff        module         view changes on edited module
submit      module         attempt to submit a module to the lunar ML
unedit      module         delete zlocal copy of a module

sum         [module]       display checksums
md5sum      [module]       display md5sums

export                     make snapshot of box's configuration.
import      snapshot       restores an exported snapshot.

section     [section]      display moonbase sections
moonbase                   display text listing of the moonbase
html                       display html listing of the moonbase
updatelog                  display summary log of previous lunar update
activity    [module]       display main log file

newer       20030801       display available modules newer than Aug 01, 2003
older       20030101       display modules installed before Jan 01, 2003

voyeur      [delay|module] peak into module compilation

pam                        display installed modules that are Linux-PAM aware

depends     module         displays installed modules that explicitly or
                               recursively depend on this module.
tree        module         displays a tree of the module's dependencies
stree       module         same as 'tree' but highly abbreviated
eert        module         same as 'tree' but reverse and installed deps only
leert       module         full reverse dependency tree

$MODULE_SCRIPT module      will print the module script for that module
"""

def _get_module_details(mod=None):
    """
    Return module object with details filled in, or None if module
    doesn't exist
    """
    if mod is None:
        return helpscreen()
    try:
        m = modules.Module(mod)
    except modules.NonexistentModuleError:
        print "{} does not exist".format(mod)
        return
    return m

def what(mod):
  """ Print out the description of the module """
  m = _get_module_details(mod)
  if m is not None:
    print m.description

def short(mod):
  """ Print out the short summary of the module """
  m = _get_module_details(mod)
  if m is not None:
    print m.details["SHORT"]

def where(mod):
  """ Print out where in the moonbase the module is located """
  m = _get_module_details(mod)
  if m is not None:
    print m.section()

def cd(mod):
  """ Spawn a shell where the module is defined in the moonbase"""
  m = _get_module_details(mod)
  if m is not None:
    os.chdir(os.path.join(config["MOONBASE"], m.section(), mod))
    os.system(os.environ["SHELL"])

def lvu_from(filename):
  """ Tell what module a file is from """
  mods = moonbase.list_installed()
  for mod in mods:
    try:
      mod_obj = modules.Module(mod, False)
      install_log = mod_obj.install_log()
      if install_log is not None:
        if filename in install_log:
          filenames = install_log.split("\n")
          for fn in filenames:
            if filename in fn:
              print "{}:{}".format(mod_obj.name, fn)
    except modules.NonexistentModuleError:
      pass

def expired(mod=None):
  """ Display a list of modules which are out of date """
  for mod in moonbase.list_expired():
    m = modules.Module(mod)
    try:
      print "{} ({} -> {})".format(mod, m.installed_version(), m.version)
    except RuntimeError:
      print "processing of DETAILS for {} failed!".format(mod)

def installed(mod):
  """ Show what version of a module is installed """
  m = _get_module_details(mod)
  if m is not None:
    if m.installed():
      print m.installed_version()
    else:
      print "{} is not installed".format(mod)

def installed_all():
  """ Give a complete list of installed modules """
  results = pkgdb.query("""
            select m.package, m.date, s.name, m.version, m.size
                from modules_states ms
                    inner join modules m on ms.module = m.package
                    inner join states s on ms.state_id = s.rowid
  """)
  for t in results:
    print "%s:%s:%s:%s:%s" % t

def version(mod):
  m = _get_module_details(mod)
  if m is not None:
    print m.version

commands = {
    "what:"       : what,
    "short:"      : short,
    "where:"      : where,
    "cd:"         : cd,
    "from:"       : lvu_from,
    "expired"     : expired,
    "installed:"  : installed,
    "installed"   : installed_all,
    "version:"    : version,
}

parser = argparse.ArgumentParser()
parser.add_argument("command", nargs = "?")
parser.add_argument("module", nargs = "?")
args = parser.parse_args()

# print args

if args.command is None:
  helpscreen()
else:
  if args.module is not None:
    command = args.command + ":"
  else:
    command = args.command

  if command in commands.keys():
    if args.module is not None:
      commands[command](args.module)
    else:
      commands[command]()
  else:
    helpscreen()
